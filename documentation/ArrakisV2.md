# ArrakisV2 Smart Contract

### **Constant/Immutable Properties**

**version** (string): a string describing the version number of the current implementation. Each change on the ArrakisV2 smart contract, like bug fixes should increment that number.

**arrakisFeeBPS** (uint16): rate in BPS of fees generated during Lping activities taken by the protocol.

**\_RESTRICTED_MINT_ENABLED** (uint16): constant used to set restrictedMintToggle and restrict mint to owner.

**factory** (IUniswapV3Factory/address): uniswap v3 factory contract used to check that pools used inside the vault are uniswap v3 pools.

**arrakisTreasury** (address): protocol address that will receive a part of fees generated by the protocol.

### **Public Properties**

**token0** (IERC20/address): ERC20 token. token0 should be smaller than token1.

**token1** (IERC20/address): ERC20 token. token1 should be greater than token0.

**init0** (uint256): number describing the amount of token0 that virtually sit on the vault, to be able to compute amount0 needed to be sent by a minter.

**init1** (uint256): number describing the amount of token1 that virtually sit on the vault, to be able to compute amount1 needed to be sent by a minter.

**ranges** (Range[]): registry of array that are used in the market making strategy.

**arrakisBalance0** (uint256): accumulated fees on token0 that can be retrieved by the protocol.

**arrakisBalance1** (uint256): accumulated fees on token1 that can be retrieved by the protocol.

**manager** (IManagerProxy/address): manager responsible to do market making activities by managing tokens of the vault and calling rebalance function. Manager may also take a share of the fees generated by uniswap v3 Lping activities.

**managerBalance0** (uint256): accumulated fees on token0 that can be retrieved by the manager.

**managerBalance1** (uint256): accumulated fees on token1 that can be retrieved by the manager.

**restrictedMintToggle** (uint16): properties containing the information if the minting is restricted to the owner. If equal to \_RESTRICTED_MINT_ENABLED only the owner can mint, otherwise anyone will be able to mint on the vault.

**maxTwapDeviation** (int24): max deviation of average price on uniswap v3 pools support by the vault during mint or burn on rebalance.

**twapDuration** (uint24): length in second of the average price.

**maxSlippage** (uint24): max slippage supported by the vault during swap action on rebalance.

### **Internal Properties**

**\_pools** (AddressSet): set of addresses of whitelisted pools, that can be used by the manager to do market making.

### _External Functions_

##### addPools

**parameters** :
- pools (address[]) : array of address representing pools that should be added.

**modifiers** : 
- should only be called by the owner.

**checks** : 
- check that pool addresses are not zero address.
- check that pools are not already whitelisted.
- check that for each pool feeTier, token0 and token1 we have corresponding pool address in uniswap v3 factory

**effect** :
- add pools to the list of whitelisted pools.

**events** :
- should emit LogAddPools event.

##### removePools

**parameters** :
- pools (address[]) : array of address representing pools that should be removed.

**modifiers** : 
- should only be called by the owner.

**checks** : 
- pools addresses should not be equal to zero address.
- pools addresses should be whitelisted pools.

**effect** :
- remove pools from the list of whitelisted pools.

**events** :
- should emit LogRemovePools event.

##### mint

**parameters** : 
- mintAmount (uint256) : number of arrakis vault's token to be mint in exchange of a certain amount of token0 and token1.
- receiver (address) : address that will receiver minted arrakis token.

 **modifiers** : 
- reentrancy protection.

**checks** : 
- mintAmount should be higher than 0.
- restrictedMintToggle should be different than 11111. Or should only be called by the owner.

**effects** : 
- computation of how much amount0 of token0 and amount1 of token1 user should send to get minAmount of ArrakisToken. Should be proportional to how much tokens are sitting on vault contract + LPs + fees generated by LPing.
- mint mintAmount of Arrakis token for receiver.

**interactions** : 
- send previously computed amount0 and amount1 of token0 and token1 to the vault from the msg.sender.

**events** : 
- LogFeesEarn : log fees earn before a user mint Arrakis Token, to get a better track of APY generated by the vault.
- LogMint : log how much Arrakis token has been mint by the receiver, and the associated amount0 and amount1 that user had to sent to vault.

##### burn

**parameters** : 
- burns (BurnLiquidity[]): list of object containing range and amount of liquidity that need to be burned.
- burnAmount (uint256): amount of Arrakis token that user want to burn.
- receiver (address): address that will receive amount0 of token0 and amount1 of token1 after the burn take place.

**modifiers** :
- reentrancy protection.

**checks** :
- total supply should higher than 0. burn cannot be called without a mint happening before.
- if left over on the vault is smaller than the amount0 and amount1 of token0 and token1, burns* array should not be empty. Because we need to burn some ranges to be able to send back amount0 and amount1 to receiver.

**effets** :
- compute amount0 of token0 and amount1 of token1 associated to the burn of burnAmount* of Arrakis token and to send it to receiver.
- if left over of token0 and token1 is not enough, we share part of fees get from burns to manager and arrakis treasury, increase their balances.

**interactions** :
- if leftover of token0 and token1 are enough, we send to receiver amount0 of token0 and amount1 of token1.
- if leftover are not enough, we burn and collect liquidity amount on ranges defines on burns\_ array. And then send to receiver amount0 of token0 and amount1 of token1.

**events** :
- LogFeesEarn : log fees earn before a user mint Arrakis Token, to get a better track of APY generated by the vault.
- LPBurned : log how much token0 and token1 we get from the burns realized on ranges defined on burns\_ array.
- LogBurn : log how much receiver is getting to burn burnAmount\_ of Arrakis token.


##### rebalance

**parameters** :
- ranges (Range[]): list of ranges that will be used during rebalance.
- rebalanceParams : struct defining actions that need to performed to do rebalance. This actions can burning liquidity, swapping tokens or/ and minting Lps on uniswap v3.
- rangesToRemove : list of ranges that will be removed because not used anymore on rebalance or Lping.

**modifiers** :
- only manager can call rebalance.
- reentrancy protection.

**checks** :
- if rebalanceParams include burn of Lp token of uniswap v3 pool, we check if current price is not too far from a average price.
- if rebalanceParams include tokens swap, we check slippage is not exceeding max slippage define vault contract. And minReturn should be lower or equal than the tokens received from swap.
- if rebalanceParams* include mint of Lp token of uniswap v3 pool, we check if current price is not too far from a average price. Check if the ranges where we want to add liquidity are whitelisted.

**effect** :
- if rebalanceParams* include burn of Lp token of uniswap v3 pool, apply fees rules, increase balance of manager and arrrakis treasury.

**interactions** :
- if rebalanceParams include burn of Lp token of uniswap v3 pool, we burn and collect liquidity amount on ranges defines on rebalanceParams*.removes array.
- if rebalanceParams include tokens swap, do tokens approvals needed for the swap and call router address with the associated payload given by rebalanceParams*.
- if rebalanceParams include mint of Lp token of uniswap v3 pool, mint on ranges defines by rebalanceParams*.deposits.

### _Internal Functions_

##### \_uniswapV3CallBack

**parameters** :
- amount0 (uint256): amount of tokens0 that should be transfered to uniswap v3 pools.
- amount1 (uint256): amount of tokens1 that should be transfered to uniswap v3 pools.

**checks** : 
- check msg.sender is one of the whitelisted pool.

**interactions** :
- transfer amount0 of token0 and amount1 of token1 to the uniswap v3 pool.

##### \_addRanges

**parameters** :
- ranges\_ (Range[]): list of ranges that need to be added.
- token0Addr\_ : address of token0.
- token1Addr\_ : address of token1.

**checks** : - check that range don't already exist.
- check that feeTier associated to theses ranges are matching current deployed uniswap v3 pools.
- check theses associated pools are whitelisted.
- check that ranges lower and upper tick are initializable ticks.

**effects** :
- add ranges.

##### \_removeRanges

**parameters** :
- ranges\_ (Range[]): list of ranges that need to be removed.

**checks** :
- check that range already exist.

**effects** :
- remove it from the array of ranges
- restructure array without that range.
